<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #1e1e1e;
      }
      .chart-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Ensure SVG elements scale properly */
      svg {
        display: block;
      }

      /* Prevent text from wrapping awkwardly */
      .node-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Style for toggle icon */
      .toggle-icon {
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .toggle-icon:hover {
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
    <div class="chart-container" style="background-color: #1e1e1e"></div>

    <script>
      var chart;

      // Function to toggle node expansion
      function toggleNode(element, nodeId, event) {
        // Prevent event from bubbling up to the node click handler
        if (event) event.stopPropagation();

        // Get the current node data
        const nodeData = chart.getNodeById(nodeId);

        // Toggle the expanded state
        chart.setExpanded(nodeId, !nodeData.data._expanded);
      }

      d3.csv(
        'https://raw.githubusercontent.com/lleiguo/orgchart/main/final.csv'
      ).then((dataFlattened) => {
        chart = new d3.OrgChart()
          .container('.chart-container')
          .data(dataFlattened)
          .rootMargin(100)
          .nodeWidth((d) => 200)
          .nodeHeight((d) => 130)
          .childrenMargin((d) => 50)
          .compactMarginBetween((d) => 30)
          .compactMarginPair((d) => 40)
          .initialZoom(0.65)
          .nodeUpdate(function(d, i, arr) {
            // Force all children to be in a single row
            if (d.children) {
              d.children.forEach((child, i) => {
                child._x = d._x + (i - (d.children.length - 1) / 2) * 250;
                child._y = d._y + 200;
              });
            }
          })
          .linkUpdate(function (d, i, arr) {
            d3.select(this)
              .attr('stroke', '#6a8af7')
              .attr('stroke-width', 1.5);
          })
          .onNodeClick(function(d, i, arr) {
            // Toggle expanded state when clicking on the node
            if (d.data._children && d.data._children.length > 0) {
              chart.setExpanded(d.id, !d.data._expanded);
            }
          })
          .nodeContent(function (d, i, arr, state) {
            const imageDim = 60;

            return `
            <div style="width:${d.width}px;height:${d.height}px;border-radius:10px;border:2px solid #6a8af7;background-color:#2a2a2a;box-sizing:border-box;position:relative;padding-top:${imageDim/2}px;">
              <div style="position:absolute;top:-${imageDim/2}px;left:50%;transform:translateX(-50%);">
                <img src="${d.data.profileUrl}" style="border-radius:100px;width:${imageDim}px;height:${imageDim}px;border:2px solid #6a8af7;background-color:#2a2a2a;" />
              </div>
              <div style="display:flex;flex-direction:column;align-items:center;height:100%;">
                <div style="color:#ffffff;font-weight:bold;font-size:18px;text-align:center;width:95%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:15px;margin-bottom:6px;">
                  ${d.data.name}
                </div>
                <div style="color:#aaaaaa;font-size:13px;text-align:center;width:95%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:${d.children && d.children.length > 0 ? '0' : '20px'};">
                  ${d.data.positionName}
                </div>
                ${d.children && d.children.length > 0 ?
                  `<div style="display:flex;align-items:center;justify-content:center;margin-top:auto;margin-bottom:10px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right:5px;">
                      <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="#aaaaaa"/>
                    </svg>
                    <span style="color:#aaaaaa;font-size:16px;margin-right:5px;">
                      ${d.children.length}
                    </span>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="toggle-icon" onclick="toggleNode(this, '${d.id}', event)">
                      <path d="${state.expanded ? 'M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z' : 'M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'}" fill="#aaaaaa"/>
                    </svg>
                  </div>` :
                  ''
                }
              </div>
            </div>
            `;
          })
          .render();

        // Center the chart and ensure proper sizing
        const container = document.querySelector('.chart-container');
        const svg = container.querySelector('svg');
        if (svg) {
          svg.style.width = '100%';
          svg.style.height = '100%';

          // Add event listener for window resize to maintain proper layout
          window.addEventListener('resize', function() {
            chart.fit();
          });

          // Add a small delay to ensure proper initial rendering
          setTimeout(() => {
            chart.fit();
            // Apply additional zoom adjustment for vertical layout
            const currentTransform = d3.zoomTransform(svg);
            d3.select(svg).call(
              d3.zoom().transform,
              d3.zoomIdentity.translate(currentTransform.x, currentTransform.y).scale(currentTransform.k * 0.8)
            );
          }, 300);
        }
      });
    </script>
    <a
      target="_blank"
      href="https://github.com/bumbeishvili/d3-organization-chart"
    >
    </a>
  </body>
 </html>
